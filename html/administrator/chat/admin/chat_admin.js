window.onload = function() {	function getXmlHttp(){	  var xmlhttp;	  try {		xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");	  } catch (e) {		try {		  xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");		} catch (E) {		  xmlhttp = false;		}	  }	  if (!xmlhttp && typeof XMLHttpRequest!="undefined") {		xmlhttp = new XMLHttpRequest();	  }	  return xmlhttp;	}	var req = getXmlHttp();		// Айпи адрес чью переписку открывать	var ip;	// Запуск таймера на проверку новых сообщений и пользователей	frefresh();	setInterval(frefresh, 10000);	// Функция проверки сообщения, пользователей	function frefresh ()	{		document.getElementById('chatlogs_left').style.color = "#000000";		document.getElementById('chatlogs_left').innerHTML = "Обновление списка сообщений";		document.getElementById('chatlogs_right').style.backgroundImage = "url(/administrator/chat/admin/images/load.gif)";		// Если айпи не пуст то отображаем поле ввода и кнопку очистки чата, иначе скрываем		if (typeof(ip) != "undefined" && ip != '')		{			document.getElementById('chat_otvet').style.display = "block";			document.getElementById('chat_panel_upr').innerHTML = "<div id=\"chat_delete_all_mess\" title=\""+ip+"\">Удалить сообщения</div>";			// Обрабатываем кнопку удаления сообщений			var chat_delete_mess = document.getElementById('chat_delete_all_mess');			chat_delete_mess.onclick = fdeletemess;		}		else		{			document.getElementById('chat_otvet').style.display = "none";			document.getElementById('chat_panel_upr').innerHTML = "<div id=\"chat_delete_all_mess\" class=\"chat_delete_all_mess_off\" title=\"Нет выбранного пользователя\">Удалить сообщения</div>";		}				req.open('POST', '/administrator/chat/admin/getmess.php', true);		req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');		req.send('ip='+encodeURIComponent(ip));		req.onreadystatechange = function()		{			if (req.readyState == 4)			{				if (req.status == 200)				{					document.getElementById('chatlogs_left').style.color = "#000000";					document.getElementById('chatlogs_left').innerHTML = "Список сообщений обновлен";					document.getElementById('chatlogs_right').style.backgroundImage = "none";					// Вставляем в скрытое окно сообщения					document.getElementById('get_info').innerHTML = req.responseText;					// Разбираем сообщения					var get_info_listuser = document.getElementById('get_info_listuser').innerHTML;					var get_info_mess = document.getElementById('get_info_mess').innerHTML;					// Вставляем из скрытого поля в нужные поля					document.getElementById('chat_list_user_li').innerHTML = get_info_listuser;					document.getElementById('chat_window_padding').innerHTML = get_info_mess;					// Удаляем содержимое из скрытых полей					document.getElementById('get_info_listuser').innerHTML = "";					document.getElementById('get_info_mess').innerHTML = "";										 // Кроссбраузерно getElementsByClassName					if (!document.getElementsByClassName)					{						document.getElementsByClassName = function (class_name)						{							// Получим коллекцию элементов тега body:							var elements = document.body.getElementsByTagName("*"),							length = elements.length,							out = [], i;							// Пройдёмся по ним... увы циклом:							for (i = 0; i < length; i++)							{								// Поместим в результирующий массив элементы, содержащие требуемый класс:								if (elements[i].className.indexOf(class_name) !== -1)								{									out.push(elements[i]);								}							}							return out;						};					}					chat_class_ip = document.getElementsByClassName('chat_class_ip_but');					for (var i = 0; i < chat_class_ip.length; i++)					{						chat_class_ip[i].onclick = function() 						{							ip = document.getElementById(this.id).innerHTML;							// Обновляем окно через секунду							setTimeout(frefresh, 1000);						}					}				}			}		}	}	// Отправка сообщения по нажатию enter	document.getElementById('chat_otvet_input').onkeydown = function ()	{		if (typeof event == "undefined")		{			event = window.event;		}		if (event.keyCode == 13)		{			fSend ();		}	};		document.getElementById('chat_button_send').onclick = fSend;		// ==== / При клике по кнопке отправляем сообщение ============================================	function fSend ()	{		// Получаем сод. поля ввода		var mess = document.getElementById('chat_otvet_input').value;		if (mess.length < 5)		{			document.getElementById('chatlogs_left').innerHTML = "Сообщение слишком короткое";			document.getElementById('chatlogs_left').style.color = "#ff0000";		}		else if (mess.length > 130)		{			document.getElementById('chatlogs_left').innerHTML = "Сообщение слишком длинное";			document.getElementById('chatlogs_left').style.color = "#ff0000";		}		else		{			document.getElementById('chatlogs_left').style.color = "#000000";			document.getElementById('chatlogs_left').innerHTML = "Отправка сообщения";			document.getElementById('chatlogs_right').style.backgroundImage = "url(/administrator/chat/frontend/img/load.gif)";			req.open('POST', '/administrator/chat/admin/sendmess.php', true);			req.setRequestHeader('Content-Type','application/x-www-form-urlencoded');			req.send('mess='+encodeURIComponent(mess) + '&ip='+encodeURIComponent(ip));			req.onreadystatechange = function()			{				if (req.readyState == 4)				{					if(req.status == 200)					{						// Очищаем поле ввода сообщения						document.getElementById('chat_otvet_input').value = "";											document.getElementById('chatlogs_left').style.color = "#000000";						document.getElementById('chatlogs_left').innerHTML = "Сообщение отправлено";						document.getElementById('chatlogs_right').style.backgroundImage = "none";						// Обновляем окно через секунду						setTimeout(frefresh, 1000);					}				}			}		}	}	// ==== / отправка сообщения =====================================================================		// ==== / Удаление сообщений ======================================================================	function fdeletemess ()	{		req.open('POST', '/administrator/chat/admin/delmess.php', true);		req.setRequestHeader('Content-Type','application/x-www-form-urlencoded');		req.send('ip='+encodeURIComponent(ip));		req.onreadystatechange = function()		{			if (req.readyState == 4)			{				if (req.status == 200)				{					// Обнуляем айпи					ip = '';					// Обновляем окно через секунду					setTimeout(frefresh, 1000);				}			}		}	}}